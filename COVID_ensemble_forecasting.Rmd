---
title: "Probabilistic ensemble forecasting of Australian COVID-19 cases"
author: "Rob J Hyndman"
date: ISF 2021
fontsize: 14pt
classoption: aspectratio=169
toc: false
output:
  binb::monash:
    fig_height: 4.33
    fig_width: 7
    colortheme: monashwhite
    keep_tex: no
    includes:
      in_header: header.tex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  cache = TRUE,
  dev.args = list(pointsize = 11)
)
options(digits = 3, width = 88)
library(tidyverse)
library(tsibble)
library(feasts)
library(fable)
library(distributional)
library(gganimate)
source("functions.R")
localcases <- readRDS("localcases.rds") %>%
  select(date, state, n) %>%
  filter(state != "AUS")
```

## Australian Health Protection Principal Committee

\begin{block}{}The \textbf{Australian Health Protection Principal Committee} is the key decision-making committee for national health emergencies. It comprises all state and territory Chief Health Officers and is chaired by the Australian Chief Medical Officer.
\end{block}

\begin{alertblock}{COVID-19 forecasting group}
\begin{multicols}{3}\small
\begin{itemize}\tightlist
\item Peter Dawson
\item Nick Golding
\item Rob J Hyndman
\item Dennis Liu
\item James M McCaw
\item Jodie McVernon
\item Pablo \rlap{Montero-Manso}
\item Robert Moss
\item Mitchell \rlap{O'Hara-Wild}
\item David J Price
\item Joshua V Ross
\item Gerry Ryan
\item Freya M Shearer
\item Tobin South
\item Ruarai Tobin
\end{itemize}
\end{multicols}\vspace*{-0.2cm}
\end{alertblock}

## Data sources

* Case-level data of all positive COVID-19 tests: onset and detection times.
* Daily population mobility data from Google, Apple & Facebook
* Weekly non-household contact surveys
* Weekly behavioural surveys
* Daily case numbers from many countries and regions via the Johns Hopkins COVID-19 repository

## Case numbers
\fontsize{12}{12}\sf

```{r, echo=TRUE}
localcases %>% filter(state == "VIC", date >= "2020-07-01")
```

## Case numbers

```{r, echo=TRUE, fig.height=3}
localcases %>% autoplot(n)
```

## Google mobility data

\vspace*{0.05cm}\includegraphics[width=15cm,height=7.5cm,keepaspectratio=true]{google}

\begin{textblock}{7}(8.7,1.4)
\begin{block}{}\small
Percentage change compared to pre-COVID-19 baseline for:
\begin{enumerate}\tightlist
\item[(a)] time at workplace;
\item[(b)] time at retail/recreation;
\item[(c)] time at transit stations.
\end{enumerate}
Vertical lines: physical distancing measures implemented.
\end{block}
\end{textblock}

## Facebook mobility data

\full{facebook}

\begin{textblock}{5.3}(10.3,.4)
\begin{block}{}\small
Proportion of Facebook users who “stayed put”, 29 Feb -- 2~Jul~2020. Each line is one LGA.
\end{block}
\end{textblock}

## Macrodistancing

\vspace*{0.05cm}\includegraphics[width=15cm,height=7.5cm,keepaspectratio=true]{macrodistancing}

\begin{textblock}{7}(8.7,1.4)
\begin{block}{}\small
\textbf{Estimated \# non-household contacts per day} based on nationwide weekly surveys (gray) and Google mobility data.\\ Green: public holidays.
\end{block}
\end{textblock}

## Microdistancing

\vspace*{0.05cm}\includegraphics[width=15cm,height=7.5cm,keepaspectratio=true]{microdistancing}

\begin{textblock}{7}(8.7,1.4)
\begin{block}{}\small
\textbf{Estimated \% keeping 1.5m distance from non-household contacts} based on nationwide weekly surveys (gray).
\end{block}
\end{textblock}

## Global daily cases by region from Johns Hopkins

\begin{alertblock}{}https://github.com/CSSEGISandData/COVID-19
\end{alertblock}

\full{jhu_dashboard}

## Model 1: SEEIIR (Uni Melbourne/Doherty Institute)

* Stochastic susceptible-exposed-infectious-recovered compartmental model that incorporates changes in local transmission potential via a time-varying effective reproduction number.
* Uses mobility and survey data and case onset and detection times.
* Daily counts $\sim$ Negative Binomial. 
* Time in class $\sim$ Gamma. 
* Forecasts obtained using a bootstrap particle filter.

## Model 2: Generative model (Uni Adelaide)

* Uses mobility and survey data and case onset and detection times.
* Three types of infectious individuals: imported, asymptomatic, symptomatic
* Class counts $\sim$ Negative Binomial. 
* Incubation times $\sim$ Gamma. 
* Estimation via Hamilton Monte Carlo
* Forecasts obtained via simulation

## Model 3: Global AR model (Monash)
\fontsize{14}{16}\sf

* Uses Johns Hopkins data from countries and regions with sufficient data.
* Series with obvious anomalies (negative cases and large step changes) removed.
* $n_{t,i}=$ daily cases on day $t$ in country/region $i$ (scaled so all data have same mean and variance).
* $y_{t,i} = \phi_1 y_{t-1,i} + \cdots +\phi_p y_{t-p,i} + \varepsilon_{t,i}$\newline where $y_{t,i} = \log(n_{t,i}+0.5)$ and $\varepsilon_{t,i}\sim N(0,\sigma_i^2)$.
* No stationarity constraints. Common coefficients.
* Current model has $p=24$ (selected to minimize the 7-day-ahead MAE on recent Australian data).

## Forecasting ensemble

* Forecasts obtained from a mixture distribution of the component models.
$$\tilde{p}(y_{t+h}|I_t) = \sum_{k=1}^3 w_{t+h|t,k} p_k(y_{t+h}|I_t)$$
where $p_k(y_{t+h}|I_t)$ is the forecast distribution from model $k$, $I_t$ denotes the data available at time $t$ and the weights $w_{t+h|t,k}>0$ sum to one.
* Also known as "linear pooling"
* Works best when individual models are over-confident and use different data sources.

## Ensemble forecasts

\only<1>{\full{vic_forecasts1}}
\only<2>{\full{vic_forecasts2}}
\only<3>{\full{vic_forecasts3}}

## Evaluating probabilistic forecasts

\begin{textblock}{9.5}(0.2,1.2)
\begin{alertblock}{}\vspace*{-0.2cm}
\begin{align*}
f_{p,t} &= \text{quantile forecast with prob. $p$ at time $t$.}\\
y_{t} &= \text{observation at time $t$}
\end{align*}
\end{alertblock}\vspace*{-0.3cm}
\uncover<2->{\begin{block}{Quantile score}\vspace*{-0.2cm}
$$
  Q_{p,t} = \begin{cases}
  2(1 - p) \big|y_t - f_{p,t}\big|, & \text{if $y_{t} < f_{p,t}$}\\
  2p \big|y_{t} - f_{p,t}\big|, & \text{if $y_{t} \ge f_{p,t}$} \end{cases}
$$
\end{block}}
\end{textblock}
\begin{textblock}{15}(0.2,5.6)
\uncover<4->{
\begin{itemize}\itemsep=0cm\parskip=0cm
\item Low $Q_{p,t}$ is good
\item Multiplier of 2 often omitted, but useful for interpretation
\item $Q_{p,t}$ like absolute error (weighted to account for likely exceedance)
\item Average $Q_{p,t}$ over $p$ = CRPS (Continuous Rank Probability Score)
\end{itemize}}
\end{textblock}
\begin{textblock}{6}(10,2)
\only<3->{\animategraphics[loop,autoplay]{10}{COVID_ensemble_forecasting_files/figure-beamer/pinball-}{1}{100}}
\end{textblock}

```{r pinball, eval=FALSE, echo=FALSE, fig.show='animate', interval=1/10, message=FALSE, fig.height=3, fig.width=5, cache=FALSE}
# Turn eval=TRUE to recompute these graphs. They are loaded in the above animategraphics call.
prob <- seq(0.05, 0.95, by = 0.05)
df <- expand.grid(
  error = c(-10, 0, 10),
  p = c(prob, rev(head(prob, -1)[-1]))
) %>%
  mutate(
    state = rep(seq(length(p) / 3), rep(3, length(p) / 3)),
    qpt = 2 * p * error * (error > 0) - 2 * (1 - p) * error * (error < 0)
  )
labels <- df %>%
  select(p, state) %>%
  distinct() %>%
  mutate(label = paste0("p = ", sprintf("%.2f", p)))
df %>% ggplot(aes(x = error, y = qpt)) +
  geom_line(aes(group = state), colour = "red") +
  labs(
    x = latex2exp::TeX("Error: $y_t - f_{p,t}$"),
    y = latex2exp::TeX("Q_{p,t}")
  ) +
  geom_label(data = labels, aes(x = 0, y = 17, label = label)) +
  transition_states(state)
```

## Ensemble forecasts

```{r combined_forecasts, eval=FALSE}
# Read weekly samples files from mediaflux and save as rds file
fs::dir_ls("~/mediaflux", glob = "*.csv") %>%
  stringr::str_subset("combined_samples_202") %>%
  purrr::map_dfr(read_csv) %>%
  nest(sample = sim1:sim2000) %>%
  group_by(date, state, .model, forecast_origin) %>%
  mutate(sample = list(unname(unlist(sample)))) %>%
  ungroup() %>%
  saveRDS(file="samples.rds")
```

```{r read_samples}
samples <- readRDS("samples.rds")
```

```{r some_plots}
samples %>% 
  filter(forecast_origin=="2020-09-18", state=="VIC", .model=="gar") %>%
  stateplot("VIC",localcases)
  
```

## More information
\fontsize{20}{24}\sf

\href{https://robjhyndman.com}{\faicon{home} robjhyndman.com}

\href{https://twitter.com/robjhyndman}{\faicon{twitter} @robjhyndman}

\href{https://github.com/robjhyndman}{\faicon{github}  @robjhyndman}

\href{mailto:rob.hyndman@monash.edu}{\faicon{envelope}  rob.hyndman@monash.edu}
